{% extends 'base.html' %}
{% load static %}

{% block title %}Generaci√≥n de Tracks - SouniQ{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col">
        <h1 class="h2 text-primary">
            <i class="fas fa-magic me-2"></i>Generaci√≥n de Tracks
        </h1>
        <p class="text-muted">Genera nuevas canciones a partir de tus archivos MIDI usando IA</p>
    </div>
</div>

<!-- MIDI Files Available -->
<div class="row mb-4">
    <div class="col">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-file-audio me-2"></i>Archivos MIDI Disponibles
                    <span class="badge bg-primary ms-2">{{ midi_files.count }}</span>
                </h5>
            </div>
            
            {% if midi_files %}
            <div class="card-body">
                <div class="row">
                    {% for midi_file in midi_files %}
                    <div class="col-lg-6 col-xl-4 mb-3">
                        <div class="midi-card bg-light p-3 rounded h-100">
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <h6 class="mb-1 text-primary">
                                    <i class="fas fa-music me-1"></i>{{ midi_file.stem.get_stem_type_display }}
                                </h6>
                                <span class="badge bg-success">MIDI</span>
                            </div>
                            
                            <p class="mb-2 small text-muted">
                                <strong>{{ midi_file.stem.song.title }}</strong><br>
                                Creado: {{ midi_file.completed_at|date:"d M Y H:i" }}
                            </p>
                            
                            <!-- Original Stem Audio -->
                            {% if midi_file.stem.file %}
                            <div class="audio-player mb-3">
                                <label class="small text-muted mb-1">Stem Original:</label>
                                <audio controls preload="metadata" class="w-100">
                                    <source src="{{ midi_file.stem.file.url }}" type="audio/mpeg">
                                    Tu navegador no soporta el elemento de audio.
                                </audio>
                            </div>
                            {% endif %}
                            
                            <div class="d-flex gap-2 flex-wrap">
                                <a href="{% url 'music_processing:download_file' 'midi' midi_file.id %}" 
                                   class="btn btn-sm btn-outline-primary">
                                    <i class="fas fa-download me-1"></i>MIDI
                                </a>
                                <form method="post" action="{% url 'music_processing:generate_track' midi_file.id %}" style="display: inline;">
                                    {% csrf_token %}
                                    <button type="submit" class="btn btn-sm btn-success">
                                        <i class="fas fa-magic me-1"></i>Generar Track
                                    </button>
                                </form>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            
            {% else %}
            <div class="card-body text-center py-4">
                <i class="fas fa-file-audio text-muted" style="font-size: 3rem;"></i>
                <h5 class="mt-3 text-muted">No tienes archivos MIDI disponibles</h5>
                <p class="text-muted">Primero necesitas convertir algunos stems a MIDI</p>
                <a href="{% url 'music_processing:midi_conversion' %}" class="btn btn-primary">
                    <i class="fas fa-file-audio me-2"></i>Ir a Conversi√≥n MIDI
                </a>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Generated Tracks History -->
{% if generated_tracks %}
<div class="row">
    <div class="col">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-history me-2"></i>Tracks Generados
                    <span class="badge bg-secondary ms-2">{{ generated_tracks.count }}</span>
                </h5>
            </div>
            
            <div class="card-body">
                <div class="row">
                    {% for track in generated_tracks %}
                    <div class="col-12 mb-4">
                        <div class="track-card border rounded h-100">
                            <div class="card-header bg-light">
                                <div class="row align-items-center">
                                    <div class="col">
                                        <h6 class="mb-0 text-primary">
                                            <i class="fas fa-compact-disc me-1"></i>{{ track.title }}
                                        </h6>
                                        <small class="text-muted">
                                            Basado en: {{ track.midi_file.stem.song.title }} - {{ track.midi_file.stem.get_stem_type_display }}
                                        </small>
                                    </div>
                                    <div class="col-auto">
                                        <span class="badge status-badge status-{{ track.status }}">
                                            {% if track.status == 'completed' %}Completado
                                            {% elif track.status == 'processing' %}Procesando
                                            {% elif track.status == 'error' %}Error
                                            {% else %}Pendiente{% endif %}
                                        </span>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="card-body">
                                {% if track.status == 'completed' %}
                                    {% if track.generated_versions.exists %}
                                    <p class="text-success mb-3">
                                        <i class="fas fa-check-circle me-1"></i>
                                        <strong>{{ track.versions_count }} versiones generadas</strong>
                                        <small class="text-muted"> - Creado: {{ track.completed_at|date:"d M Y H:i" }}</small>
                                    </p>
                                    
                                    <!-- Grid de Versiones -->
                                    <div class="row">
                                        {% for version in track.generated_versions.all %}
                                        <div class="col-lg-6 col-xl-3 mb-3">
                                            <div class="version-card bg-light p-3 rounded">
                                                <div class="d-flex justify-content-between align-items-center mb-2">
                                                    <h6 class="mb-0 text-secondary">
                                                        <i class="fas fa-music me-1"></i>Versi√≥n {{ version.version_number }}
                                                    </h6>
                                                    {% if version.file_size_mb %}
                                                    <small class="text-muted">{{ version.file_size_mb }} MB</small>
                                                    {% endif %}
                                                </div>
                                                
                                                {% if version.file %}
                                                <div class="audio-player mb-3">
                                                    <audio controls preload="metadata" class="w-100" style="height: 35px;">
                                                        <source src="{{ version.file.url }}" type="audio/mpeg">
                                                        Tu navegador no soporta el elemento de audio.
                                                    </audio>
                                                </div>
                                                
                                                <div class="d-grid">
                                                    <a href="{% url 'music_processing:download_version' version.id %}" 
                                                       class="btn btn-sm btn-primary">
                                                        <i class="fas fa-download me-1"></i>Descargar V{{ version.version_number }}
                                                    </a>
                                                </div>
                                                {% else %}
                                                <div class="alert alert-warning py-2">
                                                    <small><i class="fas fa-exclamation-triangle me-1"></i>Archivo no disponible</small>
                                                </div>
                                                {% endif %}
                                            </div>
                                        </div>
                                        {% endfor %}
                                    </div>
                                    
                                    <!-- Acciones del Track -->
                                    <hr class="my-3">
                                    <div class="d-flex gap-2">
                                        <a href="{% url 'music_processing:delete_generated_track' track.id %}" 
                                           class="btn btn-sm btn-outline-danger">
                                            <i class="fas fa-trash me-1"></i>Eliminar Track Completo
                                        </a>
                                    </div>
                                    
                                    {% else %}
                                    <!-- Track completado pero sin versiones (legacy) -->
                                    {% if track.generated_file %}
                                    <div class="audio-player mb-3">
                                        <label class="small text-muted mb-1">Track Generado (Versi√≥n √∫nica):</label>
                                        <audio controls preload="metadata" class="w-100">
                                            <source src="{{ track.generated_file.url }}" type="audio/mpeg">
                                            Tu navegador no soporta el elemento de audio.
                                        </audio>
                                    </div>
                                    
                                    <div class="d-flex gap-2">
                                        <a href="{% url 'music_processing:download_file' 'generated_track' track.id %}" 
                                           class="btn btn-sm btn-primary">
                                            <i class="fas fa-download me-1"></i>Descargar
                                        </a>
                                        <a href="{% url 'music_processing:delete_generated_track' track.id %}" 
                                           class="btn btn-sm btn-outline-danger">
                                            <i class="fas fa-trash me-1"></i>Eliminar
                                        </a>
                                    </div>
                                    {% else %}
                                    <div class="alert alert-warning py-2">
                                        <i class="fas fa-exclamation-triangle me-1"></i>
                                        <small>Track completado pero archivo no encontrado</small>
                                    </div>
                                    {% endif %}
                                    {% endif %}
                                
                                {% elif track.status == 'processing' %}
                                <div class="alert alert-warning py-2 mb-3">
                                    <i class="fas fa-spinner fa-spin me-1"></i>
                                    <strong>Generando 8 versiones...</strong><br>
                                    <small>Esto puede tardar varios minutos. La p√°gina se actualizar√° autom√°ticamente.</small>
                                </div>
                                
                                {% elif track.status == 'error' %}
                                <div class="alert alert-danger py-2 mb-3">
                                    <i class="fas fa-exclamation-circle me-1"></i>
                                    <strong>Error en la generaci√≥n</strong><br>
                                    <small>{{ track.error_message|truncatechars:100 }}</small>
                                </div>
                                
                                <div class="d-flex gap-2">
                                    <a href="{% url 'music_processing:delete_generated_track' track.id %}" 
                                       class="btn btn-sm btn-outline-danger">
                                        <i class="fas fa-trash me-1"></i>Eliminar
                                    </a>
                                </div>
                                
                                {% else %}
                                <div class="alert alert-info py-2 mb-3">
                                    <i class="fas fa-clock me-1"></i>
                                    <strong>En cola para procesamiento</strong><br>
                                    <small>El track ser√° procesado pr√≥ximamente</small>
                                </div>
                                
                                <div class="d-flex gap-2">
                                    <a href="{% url 'music_processing:delete_generated_track' track.id %}" 
                                       class="btn btn-sm btn-outline-danger">
                                        <i class="fas fa-trash me-1"></i>Eliminar
                                    </a>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Help Modal -->
<div class="modal fade" id="helpModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-question-circle me-2"></i>Ayuda - Generaci√≥n de Tracks
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <h6>Par√°metros de Generaci√≥n:</h6>
                <ul class="small">
                    <li><strong>Creatividad (Temperatura):</strong> Controla qu√© tan creativa es la generaci√≥n
                        <ul>
                            <li>0.1-0.5: Muy conservador, se mantiene cerca del original</li>
                            <li>0.6-1.0: Equilibrado entre originalidad y creatividad</li>
                            <li>1.1-2.0: Muy creativo, puede generar variaciones sorprendentes</li>
                        </ul>
                    </li>
                    <li><strong>Incluir bater√≠a:</strong> A√±ade elementos de percusi√≥n a la generaci√≥n</li>
                </ul>
                
                <h6 class="mt-3">Configuraci√≥n autom√°tica de Orpheus:</h6>
                <ul class="small">
                    <li>Tokens de entrada: 6656 (optimizado)</li>
                    <li>Tokens de generaci√≥n: 512 (duraci√≥n equilibrada)</li>
                    <li>Diversidad (Top-p): 0.96 (alta calidad)</li>
                    <li>Limpieza de MIDI: autom√°tica</li>
                    <li>Aplicaci√≥n de sustains: autom√°tica</li>
                </ul>
                
                <h6 class="mt-3">Consejos:</h6>
                <ul class="small">
                    <li>Para m√∫sica similar al original: usa creatividad entre 0.5-0.8</li>
                    <li>Para experimentar y obtener variaciones interesantes: usa 1.0-1.5</li>
                    <li>La bater√≠a funciona mejor con g√©neros r√≠tmicos</li>
                    <li>El proceso puede tardar hasta 15 minutos</li>
                </ul>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
            </div>
        </div>
    </div>
</div>

<!-- Help Button -->
<div class="position-fixed bottom-0 end-0 p-3">
    <button class="btn btn-info btn-sm rounded-circle me-2" data-bs-toggle="modal" data-bs-target="#helpModal">
        <i class="fas fa-question"></i>
    </button>
</div>
{% endblock %}

{% block extra_css %}
<style>
.midi-card, .track-card {
    transition: all 0.3s ease;
    border: 1px solid #e9ecef;
}

.midi-card:hover, .track-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}

.status-badge {
    font-size: 0.75rem;
}

.status-completed { background-color: #198754; }
.status-processing { background-color: #ffc107; color: #000; }
.status-error { background-color: #dc3545; }
.status-pending { background-color: #6c757d; }

.audio-player audio {
    height: 35px;
}

.alert {
    font-size: 0.85rem;
}

.form-text {
    font-size: 0.8rem;
}

/* Estilos para las versiones */
.version-card {
    transition: all 0.2s ease;
    border: 1px solid #dee2e6;
    background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
}

.version-card:hover {
    transform: translateY(-1px);
    box-shadow: 0 2px 6px rgba(0,0,0,0.08);
    border-color: #007bff;
}

.version-card h6 {
    font-size: 0.9rem;
    font-weight: 600;
}

.version-card .btn {
    font-size: 0.8rem;
    padding: 0.375rem 0.75rem;
    font-weight: 500;
}

.version-card audio {
    height: 30px;
    border-radius: 4px;
}

/* Responsive grid para versiones */
@media (max-width: 1199.98px) {
    .version-card {
        margin-bottom: 1rem;
    }
}

@media (max-width: 991.98px) {
    .col-lg-6.col-xl-3 {
        flex: 0 0 50%;
        max-width: 50%;
    }
}

@media (max-width: 575.98px) {
    .col-lg-6.col-xl-3 {
        flex: 0 0 100%;
        max-width: 100%;
    }
}

/* Animaci√≥n para el badge de cantidad de versiones */
.versions-count {
    animation: pulse 2s infinite;
}

@keyframes pulse {
    0% { transform: scale(1); }
    50% { transform: scale(1.05); }
    100% { transform: scale(1); }
}
</style>
{% endblock %}

{% block extra_js %}
<script>
// Inicializar sistema de auto-refresh para tareas en progreso
document.addEventListener('DOMContentLoaded', function() {
    console.log('üîß Track generation page loaded');
    
    // Auto-refresh para tareas en progreso
    const processingElements = document.querySelectorAll('.status-processing');
    
    if (processingElements.length > 0) {
        // Refrescar cada 30 segundos si hay generaciones en progreso
        setTimeout(function() {
            window.location.reload();
        }, 30000);
    }
    
    // Usar event delegation en el document para capturar clics en botones de generar
    document.addEventListener('click', function(e) {
        console.log('üîß Click detected on:', e.target.tagName, e.target.className);
        
        // Debug m√°s espec√≠fico
        if (e.target && e.target.tagName === 'BUTTON') {
            console.log('üîß Button clicked, type:', e.target.type);
            console.log('üîß Button text:', e.target.textContent.trim());
            
            const form = e.target.closest('form');
            if (form) {
                console.log('üîß Form action:', form.action);
                console.log('üîß Form action contains generate_track:', form.action.includes('generate_track'));
            }
        }
        
        // Verificar si es un bot√≥n dentro de un formulario de generar track
        if (e.target && e.target.tagName === 'BUTTON' && 
            e.target.type === 'submit' && 
            e.target.textContent.includes('Generar Track')) {
            
            console.log('üîß Generate track button clicked');
            e.preventDefault();
            e.stopPropagation();
            
            const button = e.target;
            const form = button.closest('form');
            
            console.log('üîß Button found:', !!button);
            console.log('üîß Form found:', !!form);
            
            // Verificar que es el formulario correcto
            if (!form || !form.action.includes('generate_track')) {
                console.log('üîß Not the correct form, allowing default behavior');
                return;
            }
            
            // Obtener informaci√≥n del MIDI desde el card
            const midiCard = form.closest('.midi-card');
            console.log('üîß MIDI card found:', !!midiCard);
            
            if (!midiCard) {
                console.error('‚ùå No se encontr√≥ el MIDI card');
                // Fallback: enviar formulario normalmente
                form.submit();
                return;
            }
            
            const songTitleElement = midiCard.querySelector('p strong');
            const stemTypeElement = midiCard.querySelector('h6');
            
            const songTitle = songTitleElement ? songTitleElement.textContent.trim() : 'Canci√≥n';
            const stemType = stemTypeElement ? stemTypeElement.textContent.replace('üéµ', '').trim() : 'Stem';
            
            const trackTitle = `Nueva canci√≥n basada en ${songTitle}`;
            const midiSource = `${songTitle} - ${stemType}`;
            
            console.log('üîß Track info:', { trackTitle, midiSource });
            
            // Confirmar antes de proceder
            const confirmed = confirm('¬øEst√°s seguro de que quieres generar esta canci√≥n? El proceso puede tardar hasta 15 minutos.');
            console.log('üîß User confirmed:', confirmed);
            
            if (!confirmed) {
                return;
            }
            
            // Mostrar overlay de procesamiento
            console.log('üîß Showing processing overlay...');
            if (typeof window.processingOverlay !== 'undefined') {
                showTrackProcessing(trackTitle, midiSource);
            } else {
                console.warn('‚ö†Ô∏è processingOverlay not available');
            }
            
            // Enviar formulario despu√©s de un peque√±o delay para que se vea el overlay
            setTimeout(() => {
                console.log('üîß Submitting form...');
                form.submit();
            }, 500);
        }
    });
});

// Funci√≥n espec√≠fica para mostrar procesamiento de generaci√≥n de tracks (llamada desde base.html)
function showTrackProcessing(trackTitle, midiSource) {
    if (typeof processingOverlay !== 'undefined') {
        let message = 'Creando m√∫ltiples versiones usando IA. Esto puede tardar varios minutos.';
        if (trackTitle && midiSource) {
            message = `Creando "${trackTitle}" basada en ${midiSource}`;
        } else if (trackTitle) {
            message = `Creando "${trackTitle}"`;
        }
        
        processingOverlay.show({
            title: 'Generando Nueva Canci√≥n',
            message: message,
            icon: 'fas fa-magic fa-spin fa-3x text-success'
        });
        
        processingOverlay.setStatus('Inicializando modelo de IA musical...');
        
        // Simular progreso espec√≠fico para generaci√≥n de tracks
        let progress = 0;
        const interval = setInterval(() => {
            progress += Math.random() * 8; // Progreso m√°s lento para tracks
            if (progress >= 95) {
                progress = 95;
                clearInterval(interval);
            }
            
            processingOverlay.setProgress(progress);
            
            // Actualizar mensaje de progreso
            if (progress < 15) {
                processingOverlay.setStatus('Cargando modelo Orpheus-Music-Transformer...');
            } else if (progress < 30) {
                processingOverlay.setStatus('Analizando MIDI de entrada...');
            } else if (progress < 50) {
                processingOverlay.setStatus('Generando estructura musical...');
            } else if (progress < 70) {
                processingOverlay.setStatus('Creando melod√≠as y armon√≠as...');
            } else if (progress < 85) {
                processingOverlay.setStatus('Desarrollando variaciones musicales...');
            } else {
                processingOverlay.setStatus('Finalizando y preparando descarga...');
            }
        }, 3000 + Math.random() * 2000); // Intervalos m√°s largos para tracks
    }
}

// Funci√≥n para mostrar progreso de tracks ya en procesamiento
function showExistingTrackProgress(trackTitle) {
    if (typeof processingOverlay !== 'undefined') {
        processingOverlay.show({
            title: 'Generaci√≥n en Progreso',
            message: `La canci√≥n "${trackTitle}" se est√° generando`,
            icon: 'fas fa-magic fa-spin fa-3x text-success'
        });
        
        processingOverlay.setStatus('Esta p√°gina se actualizar√° autom√°ticamente cuando est√© lista...');
        
        // Progreso indeterminado para tracks existentes
        let progress = 50;
        processingOverlay.setProgress(progress);
        
        const interval = setInterval(() => {
            progress += (Math.random() - 0.5) * 10;
            progress = Math.max(30, Math.min(95, progress));
            processingOverlay.setProgress(progress);
        }, 5000);
        
        // Auto-ocultar despu√©s de un tiempo
        setTimeout(() => {
            clearInterval(interval);
            processingOverlay.hide();
        }, 20000);
    }
}
</script>
{% endblock %}
