{% extends 'base.html' %}
{% load static %}

{% block title %}Generaci√≥n de Tracks - SouniQ{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col">
        <h1 class="h2 text-primary">
            <i class="fas fa-magic me-2"></i>Generaci√≥n de Tracks
        </h1>
        <p class="text-muted">Genera nuevas canciones a partir de tus archivos MIDI usando IA</p>
    </div>
</div>

<!-- MIDI Files Available -->
<div class="row mb-4">
    <div class="col">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-file-audio me-2"></i>Archivos MIDI Disponibles
                    <span class="badge bg-primary ms-2">{{ midi_files.count }}</span>
                </h5>
            </div>
            
            {% if midi_files %}
            <div class="card-body">
                <div class="row">
                    {% for midi_file in midi_files %}
                    <div class="col-lg-6 col-xl-4 mb-3">
                        <div class="midi-card bg-light p-3 rounded h-100">
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <h6 class="mb-1 text-primary">
                                    <i class="fas fa-music me-1"></i>{{ midi_file.stem.get_stem_type_display }}
                                </h6>
                                <span class="badge bg-success">MIDI</span>
                            </div>
                            
                            <p class="mb-2 small text-muted">
                                <strong>{{ midi_file.stem.song.title }}</strong><br>
                                Creado: {{ midi_file.completed_at|date:"d M Y H:i" }}
                            </p>
                            
                            <!-- Original Stem Audio -->
                            {% if midi_file.stem.file %}
                            <div class="audio-player mb-3">
                                <label class="small text-muted mb-1">Stem Original:</label>
                                <audio controls preload="metadata" class="w-100">
                                    <source src="{{ midi_file.stem.file.url }}" type="audio/mpeg">
                                    Tu navegador no soporta el elemento de audio.
                                </audio>
                            </div>
                            {% endif %}
                            
                            <div class="d-flex gap-2 flex-wrap">
                                <a href="{% url 'music_processing:download_file' 'midi' midi_file.id %}" 
                                   class="btn btn-sm btn-outline-primary">
                                    <i class="fas fa-download me-1"></i>MIDI
                                </a>
                                <button class="btn btn-sm btn-success" 
                                        data-bs-toggle="modal" 
                                        data-bs-target="#generateModal"
                                        data-midi-id="{{ midi_file.id }}"
                                        data-midi-title="{{ midi_file.stem.song.title }} - {{ midi_file.stem.get_stem_type_display }}">
                                    <i class="fas fa-magic me-1"></i>Generar Track
                                </button>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            
            {% else %}
            <div class="card-body text-center py-4">
                <i class="fas fa-file-audio text-muted" style="font-size: 3rem;"></i>
                <h5 class="mt-3 text-muted">No tienes archivos MIDI disponibles</h5>
                <p class="text-muted">Primero necesitas convertir algunos stems a MIDI</p>
                <a href="{% url 'music_processing:midi_conversion' %}" class="btn btn-primary">
                    <i class="fas fa-file-audio me-2"></i>Ir a Conversi√≥n MIDI
                </a>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Generated Tracks History -->
{% if generated_tracks %}
<div class="row">
    <div class="col">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-history me-2"></i>Tracks Generados
                    <span class="badge bg-secondary ms-2">{{ generated_tracks.count }}</span>
                </h5>
            </div>
            
            <div class="card-body">
                <div class="row">
                    {% for track in generated_tracks %}
                    <div class="col-12 mb-4">
                        <div class="track-card border rounded h-100">
                            <div class="card-header bg-light">
                                <div class="row align-items-center">
                                    <div class="col">
                                        <h6 class="mb-0 text-primary">
                                            <i class="fas fa-compact-disc me-1"></i>{{ track.title }}
                                        </h6>
                                        <small class="text-muted">
                                            Basado en: {{ track.midi_file.stem.song.title }} - {{ track.midi_file.stem.get_stem_type_display }}
                                        </small>
                                    </div>
                                    <div class="col-auto">
                                        <span class="badge status-badge status-{{ track.status }}">
                                            {% if track.status == 'completed' %}Completado
                                            {% elif track.status == 'processing' %}Procesando
                                            {% elif track.status == 'error' %}Error
                                            {% else %}Pendiente{% endif %}
                                        </span>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="card-body">
                                {% if track.status == 'completed' %}
                                    {% if track.generated_versions.exists %}
                                    <p class="text-success mb-3">
                                        <i class="fas fa-check-circle me-1"></i>
                                        <strong>{{ track.versions_count }} versiones generadas</strong>
                                        <small class="text-muted"> - Creado: {{ track.completed_at|date:"d M Y H:i" }}</small>
                                    </p>
                                    
                                    <!-- Grid de Versiones -->
                                    <div class="row">
                                        {% for version in track.generated_versions.all %}
                                        <div class="col-lg-6 col-xl-3 mb-3">
                                            <div class="version-card bg-light p-3 rounded">
                                                <div class="d-flex justify-content-between align-items-center mb-2">
                                                    <h6 class="mb-0 text-secondary">
                                                        <i class="fas fa-music me-1"></i>Versi√≥n {{ version.version_number }}
                                                    </h6>
                                                    {% if version.file_size_mb %}
                                                    <small class="text-muted">{{ version.file_size_mb }} MB</small>
                                                    {% endif %}
                                                </div>
                                                
                                                {% if version.file %}
                                                <div class="audio-player mb-3">
                                                    <audio controls preload="metadata" class="w-100" style="height: 35px;">
                                                        <source src="{{ version.file.url }}" type="audio/mpeg">
                                                        Tu navegador no soporta el elemento de audio.
                                                    </audio>
                                                </div>
                                                
                                                <div class="d-grid">
                                                    <a href="{% url 'music_processing:download_version' version.id %}" 
                                                       class="btn btn-sm btn-primary">
                                                        <i class="fas fa-download me-1"></i>Descargar V{{ version.version_number }}
                                                    </a>
                                                </div>
                                                {% else %}
                                                <div class="alert alert-warning py-2">
                                                    <small><i class="fas fa-exclamation-triangle me-1"></i>Archivo no disponible</small>
                                                </div>
                                                {% endif %}
                                            </div>
                                        </div>
                                        {% endfor %}
                                    </div>
                                    
                                    <!-- Acciones del Track -->
                                    <hr class="my-3">
                                    <div class="d-flex gap-2">
                                        <a href="{% url 'music_processing:delete_generated_track' track.id %}" 
                                           class="btn btn-sm btn-outline-danger">
                                            <i class="fas fa-trash me-1"></i>Eliminar Track Completo
                                        </a>
                                    </div>
                                    
                                    {% else %}
                                    <!-- Track completado pero sin versiones (legacy) -->
                                    {% if track.generated_file %}
                                    <div class="audio-player mb-3">
                                        <label class="small text-muted mb-1">Track Generado (Versi√≥n √∫nica):</label>
                                        <audio controls preload="metadata" class="w-100">
                                            <source src="{{ track.generated_file.url }}" type="audio/mpeg">
                                            Tu navegador no soporta el elemento de audio.
                                        </audio>
                                    </div>
                                    
                                    <div class="d-flex gap-2">
                                        <a href="{% url 'music_processing:download_file' 'generated_track' track.id %}" 
                                           class="btn btn-sm btn-primary">
                                            <i class="fas fa-download me-1"></i>Descargar
                                        </a>
                                        <a href="{% url 'music_processing:delete_generated_track' track.id %}" 
                                           class="btn btn-sm btn-outline-danger">
                                            <i class="fas fa-trash me-1"></i>Eliminar
                                        </a>
                                    </div>
                                    {% else %}
                                    <div class="alert alert-warning py-2">
                                        <i class="fas fa-exclamation-triangle me-1"></i>
                                        <small>Track completado pero archivo no encontrado</small>
                                    </div>
                                    {% endif %}
                                    {% endif %}
                                
                                {% elif track.status == 'processing' %}
                                <div class="alert alert-warning py-2 mb-3">
                                    <i class="fas fa-spinner fa-spin me-1"></i>
                                    <strong>Generando 8 versiones...</strong><br>
                                    <small>Esto puede tardar varios minutos. La p√°gina se actualizar√° autom√°ticamente.</small>
                                </div>
                                
                                {% elif track.status == 'error' %}
                                <div class="alert alert-danger py-2 mb-3">
                                    <i class="fas fa-exclamation-circle me-1"></i>
                                    <strong>Error en la generaci√≥n</strong><br>
                                    <small>{{ track.error_message|truncatechars:100 }}</small>
                                </div>
                                
                                <div class="d-flex gap-2">
                                    <a href="{% url 'music_processing:delete_generated_track' track.id %}" 
                                       class="btn btn-sm btn-outline-danger">
                                        <i class="fas fa-trash me-1"></i>Eliminar
                                    </a>
                                </div>
                                
                                {% else %}
                                <div class="alert alert-info py-2 mb-3">
                                    <i class="fas fa-clock me-1"></i>
                                    <strong>En cola para procesamiento</strong><br>
                                    <small>El track ser√° procesado pr√≥ximamente</small>
                                </div>
                                
                                <div class="d-flex gap-2">
                                    <a href="{% url 'music_processing:delete_generated_track' track.id %}" 
                                       class="btn btn-sm btn-outline-danger">
                                        <i class="fas fa-trash me-1"></i>Eliminar
                                    </a>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Generation Modal -->
<div class="modal fade" id="generateModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-magic me-2"></i>Generar Nueva Canci√≥n
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            
            <form method="post" id="generateForm">
                <div class="modal-body">
                    {% csrf_token %}
                    <input type="hidden" name="midi_id" id="selectedMidiId">
                    
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        <strong>MIDI seleccionado:</strong> <span id="selectedMidiTitle"></span>
                    </div>
                    
                    <div class="row">
                        <div class="col-12">
                            <div class="mb-3">
                                <label for="{{ form.title.id_for_label }}" class="form-label">{{ form.title.label }}</label>
                                {{ form.title }}
                                {% if form.title.help_text %}<div class="form-text">{{ form.title.help_text }}</div>{% endif %}
                                {% if form.title.errors %}<div class="text-danger small">{{ form.title.errors.0 }}</div>{% endif %}
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="{{ form.model_temperature.id_for_label }}" class="form-label">{{ form.model_temperature.label }}</label>
                                {{ form.model_temperature }}
                                {% if form.model_temperature.help_text %}<div class="form-text">{{ form.model_temperature.help_text }}</div>{% endif %}
                                {% if form.model_temperature.errors %}<div class="text-danger small">{{ form.model_temperature.errors.0 }}</div>{% endif %}
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-check mt-4">
                                {{ form.add_drums }}
                                <label class="form-check-label" for="{{ form.add_drums.id_for_label }}">
                                    {{ form.add_drums.label }}
                                </label>
                                {% if form.add_drums.help_text %}<div class="form-text">{{ form.add_drums.help_text }}</div>{% endif %}
                            </div>
                        </div>
                    </div>
                    
                    <div class="alert alert-info mt-3">
                        <i class="fas fa-info-circle me-2"></i>
                        <strong>Configuraci√≥n optimizada:</strong> Orpheus-Music-Transformer usa configuraciones avanzadas autom√°ticamente para la mejor calidad musical. Solo necesitas ajustar la creatividad y decidir si incluir bater√≠a.
                    </div>
                    
                    <div class="alert alert-warning mt-3">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        <strong>Importante:</strong> La generaci√≥n puede tardar entre 5-15 minutos. El archivo se descargar√° autom√°ticamente cuando est√© listo.
                    </div>
                </div>
                
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary" id="generateBtn">
                        <i class="fas fa-magic me-2"></i>Generar Track
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Help Modal -->
<div class="modal fade" id="helpModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-question-circle me-2"></i>Ayuda - Generaci√≥n de Tracks
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <h6>Par√°metros de Generaci√≥n:</h6>
                <ul class="small">
                    <li><strong>Creatividad (Temperatura):</strong> Controla qu√© tan creativa es la generaci√≥n
                        <ul>
                            <li>0.1-0.5: Muy conservador, se mantiene cerca del original</li>
                            <li>0.6-1.0: Equilibrado entre originalidad y creatividad</li>
                            <li>1.1-2.0: Muy creativo, puede generar variaciones sorprendentes</li>
                        </ul>
                    </li>
                    <li><strong>Incluir bater√≠a:</strong> A√±ade elementos de percusi√≥n a la generaci√≥n</li>
                </ul>
                
                <h6 class="mt-3">Configuraci√≥n autom√°tica de Orpheus:</h6>
                <ul class="small">
                    <li>Tokens de entrada: 6656 (optimizado)</li>
                    <li>Tokens de generaci√≥n: 512 (duraci√≥n equilibrada)</li>
                    <li>Diversidad (Top-p): 0.96 (alta calidad)</li>
                    <li>Limpieza de MIDI: autom√°tica</li>
                    <li>Aplicaci√≥n de sustains: autom√°tica</li>
                </ul>
                
                <h6 class="mt-3">Consejos:</h6>
                <ul class="small">
                    <li>Para m√∫sica similar al original: usa creatividad entre 0.5-0.8</li>
                    <li>Para experimentar y obtener variaciones interesantes: usa 1.0-1.5</li>
                    <li>La bater√≠a funciona mejor con g√©neros r√≠tmicos</li>
                    <li>El proceso puede tardar hasta 15 minutos</li>
                </ul>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
            </div>
        </div>
    </div>
</div>

<!-- Help Button -->
<div class="position-fixed bottom-0 end-0 p-3">
    <button class="btn btn-info btn-sm rounded-circle me-2" data-bs-toggle="modal" data-bs-target="#helpModal">
        <i class="fas fa-question"></i>
    </button>
</div>
{% endblock %}

{% block extra_css %}
<style>
.midi-card, .track-card {
    transition: all 0.3s ease;
    border: 1px solid #e9ecef;
}

.midi-card:hover, .track-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}

.status-badge {
    font-size: 0.75rem;
}

.status-completed { background-color: #198754; }
.status-processing { background-color: #ffc107; color: #000; }
.status-error { background-color: #dc3545; }
.status-pending { background-color: #6c757d; }

.audio-player audio {
    height: 35px;
}

.alert {
    font-size: 0.85rem;
}

.form-text {
    font-size: 0.8rem;
}

/* Estilos para las versiones */
.version-card {
    transition: all 0.2s ease;
    border: 1px solid #dee2e6;
    background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
}

.version-card:hover {
    transform: translateY(-1px);
    box-shadow: 0 2px 6px rgba(0,0,0,0.08);
    border-color: #007bff;
}

.version-card h6 {
    font-size: 0.9rem;
    font-weight: 600;
}

.version-card .btn {
    font-size: 0.8rem;
    padding: 0.375rem 0.75rem;
    font-weight: 500;
}

.version-card audio {
    height: 30px;
    border-radius: 4px;
}

/* Responsive grid para versiones */
@media (max-width: 1199.98px) {
    .version-card {
        margin-bottom: 1rem;
    }
}

@media (max-width: 991.98px) {
    .col-lg-6.col-xl-3 {
        flex: 0 0 50%;
        max-width: 50%;
    }
}

@media (max-width: 575.98px) {
    .col-lg-6.col-xl-3 {
        flex: 0 0 100%;
        max-width: 100%;
    }
}

/* Animaci√≥n para el badge de cantidad de versiones */
.versions-count {
    animation: pulse 2s infinite;
}

@keyframes pulse {
    0% { transform: scale(1); }
    50% { transform: scale(1.05); }
    100% { transform: scale(1); }
}
</style>
{% endblock %}

{% block extra_js %}
<script>
// Inicializar sistema de overlay de procesamiento
document.addEventListener('DOMContentLoaded', function() {
    // Auto-refresh para tareas en progreso
    const processingElements = document.querySelectorAll('.status-processing');
    
    if (processingElements.length > 0) {
        // Refrescar cada 30 segundos si hay generaciones en progreso
        setTimeout(function() {
            window.location.reload();
        }, 30000);
    }
    
    // Validaciones en tiempo real
    const temperatureInput = document.getElementById('{{ form.model_temperature.id_for_label }}');
    const topPInput = document.getElementById('{{ form.model_sampling_top_p.id_for_label }}');
    
    if (temperatureInput) {
        temperatureInput.addEventListener('input', function() {
            const value = parseFloat(this.value);
            if (value < 0.1 || value > 2.0) {
                this.setCustomValidity('La temperatura debe estar entre 0.1 y 2.0');
            } else {
                this.setCustomValidity('');
            }
        });
    }
    
    if (topPInput) {
        topPInput.addEventListener('input', function() {
            const value = parseFloat(this.value);
            if (value < 0.1 || value > 1.0) {
                this.setCustomValidity('El valor top-p debe estar entre 0.1 y 1.0');
            } else {
                this.setCustomValidity('');
            }
        });
    }
});

// Configurar modal de generaci√≥n
document.querySelectorAll('[data-bs-target="#generateModal"]').forEach(function(button) {
    button.addEventListener('click', function() {
        const midiId = this.dataset.midiId;
        const midiTitle = this.dataset.midiTitle;
        
        // Verificar que los elementos existen antes de usarlos
        const selectedMidiIdInput = document.getElementById('selectedMidiId');
        const selectedMidiTitleSpan = document.getElementById('selectedMidiTitle');
        const titleField = document.getElementById('{{ form.title.id_for_label }}');
        const form = document.getElementById('generateForm');
        
        console.log('üîß Configurando modal con MIDI:', midiId, midiTitle);
        console.log('üîß Elementos encontrados:', {
            selectedMidiId: !!selectedMidiIdInput,
            selectedMidiTitle: !!selectedMidiTitleSpan,
            titleField: !!titleField,
            form: !!form
        });
        
        // Solo asignar si los elementos existen
        if (selectedMidiIdInput) {
            selectedMidiIdInput.value = midiId;
        } else {
            console.error('‚ùå selectedMidiId input no encontrado');
        }
        
        if (selectedMidiTitleSpan) {
            selectedMidiTitleSpan.textContent = midiTitle;
        } else {
            console.error('‚ùå selectedMidiTitle span no encontrado');
        }
        
        // Auto-rellenar t√≠tulo basado en el MIDI
        if (titleField && !titleField.value) {
            titleField.value = 'Nueva canci√≥n basada en ' + midiTitle;
        }
        
        // Actualizar la acci√≥n del formulario
        if (form) {
            form.action = '{% url "music_processing:generate_track" 0 %}'.replace('0', midiId);
        } else {
            console.error('‚ùå generateForm no encontrado');
        }
        
        // Resetear el estado del bot√≥n por si qued√≥ en estado "Generando..."
        const generateBtn = document.getElementById('generateBtn');
        if (generateBtn) {
            generateBtn.disabled = false;
            generateBtn.innerHTML = '<i class="fas fa-magic me-2"></i>Generar Track';
        }
        
        // Si el modal est√° vac√≠o, intentar restaurar el contenido
        const modal = document.getElementById('generateModal');
        const modalBody = modal ? modal.querySelector('.modal-body') : null;
        
        if (modalBody && modalBody.children.length === 0) {
            console.error('‚ùå Modal body est√° vac√≠o - intentando restaurar...');
            location.reload(); // Soluci√≥n dr√°stica pero efectiva
        }
    });
});

// Event listener para resetear modal cuando se abre
document.getElementById('generateModal').addEventListener('show.bs.modal', function(event) {
    console.log('üîç DEBUG: Modal abriendo...');
    
    // Resetear estado del formulario y bot√≥n
    const generateBtn = document.getElementById('generateBtn');
    const form = document.getElementById('generateForm');
    
    // Asegurar que el bot√≥n est√© habilitado y con el texto correcto
    generateBtn.disabled = false;
    generateBtn.innerHTML = '<i class="fas fa-magic me-2"></i>Generar Track';
    
    // Resetear validaciones del formulario
    form.classList.remove('was-validated');
    
    // Asegurar que todos los elementos del modal est√°n visibles
    const modalBody = this.querySelector('.modal-body');
    if (modalBody) {
        modalBody.style.display = '';
        modalBody.style.visibility = '';
    }
    
    // DEBUG COMPLETO: verificar que los mensajes de alerta est√°n presentes
    const alertInfo = this.querySelector('.alert-info');
    const alertWarning = this.querySelector('.alert-warning');
    const allAlerts = this.querySelectorAll('.alert');
    
    console.log('üîç Modal generateModal abierto y reseteado');
    console.log('üîç Total alertas encontradas:', allAlerts.length);
    
    // Verificar cada alerta espec√≠ficamente por contenido
    let midiAlert = null;
    let configAlert = null;
    let importantAlert = null;
    
    allAlerts.forEach((alert, index) => {
        const text = alert.textContent;
        const styles = getComputedStyle(alert);
        
        console.log(`üîç Alert ${index}:`);
        console.log(`   - Display: ${styles.display}, Visibility: ${styles.visibility}, Opacity: ${styles.opacity}`);
        console.log(`   - Contenido: "${text.substring(0, 50).trim()}..."`);
        
        if (text.includes('MIDI seleccionado')) {
            midiAlert = alert;
            console.log(`   ‚úÖ Es la alerta de MIDI seleccionado`);
        } else if (text.includes('Configuraci√≥n optimizada')) {
            configAlert = alert;
            console.log(`   ‚úÖ Es la alerta de Configuraci√≥n optimizada`);
        } else if (text.includes('Importante') && text.includes('generaci√≥n puede tardar')) {
            importantAlert = alert;
            console.log(`   ‚úÖ Es la alerta de Importante`);
        } else {
            console.log(`   ‚ùì Alerta desconocida`);
        }
    });
    
    console.log('üìã RESUMEN:');
    console.log('   - Alerta MIDI:', !!midiAlert ? '‚úÖ Presente' : '‚ùå Ausente');
    console.log('   - Alerta Config:', !!configAlert ? '‚úÖ Presente' : '‚ùå Ausente');
    console.log('   - Alerta Important:', !!importantAlert ? '‚úÖ Presente' : '‚ùå Ausente');
    
    // Si falta la alerta de configuraci√≥n, intentar encontrarla en el DOM completo
    if (!configAlert) {
        console.log('‚ùå PROBLEMA: Falta la alerta de Configuraci√≥n optimizada');
        const globalConfigAlert = document.querySelector('*:not(script):not(style)');
        const bodyText = document.body.textContent;
        const hasConfigText = bodyText.includes('Configuraci√≥n optimizada');
        console.log('üîç Texto "Configuraci√≥n optimizada" existe en la p√°gina:', hasConfigText);
        
        if (hasConfigText) {
            console.log('üîç El texto existe pero no est√° en el modal - posible problema de DOM');
        }
    }
});

// Event listener para limpiar estado cuando el modal se cierra
document.getElementById('generateModal').addEventListener('hidden.bs.modal', function(event) {
    // Resetear completamente el formulario
    const form = document.getElementById('generateForm');
    const generateBtn = document.getElementById('generateBtn');
    
    // Resetear bot√≥n
    generateBtn.disabled = false;
    generateBtn.innerHTML = '<i class="fas fa-magic me-2"></i>Generar Track';
    
    // Limpiar campos del formulario
    const titleField = document.getElementById('{{ form.title.id_for_label }}');
    if (titleField) {
        titleField.value = '';
    }
    
    // Resetear validaciones
    form.classList.remove('was-validated');
    
    console.log('Modal generateModal cerrado y limpiado');
});

// Manejo del formulario de generaci√≥n con overlay
document.getElementById('generateForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const button = document.getElementById('generateBtn');
    const selectedMidiTitleSpan = document.getElementById('selectedMidiTitle');
    const titleField = document.getElementById('{{ form.title.id_for_label }}');
    
    // Verificaci√≥n defensiva
    if (!selectedMidiTitleSpan) {
        console.error('‚ùå Modal corrupto - selectedMidiTitle no existe');
        alert('Error: El modal no est√° funcionando correctamente. La p√°gina se recargar√°.');
        location.reload();
        return;
    }
    
    const midiTitle = selectedMidiTitleSpan.textContent;
    const trackTitle = titleField ? titleField.value || 'Nueva canci√≥n' : 'Nueva canci√≥n';
    
    if (!confirm('¬øEst√°s seguro de que quieres generar esta canci√≥n? El proceso puede tardar hasta 15 minutos.')) {
        return;
    }
    
    // Deshabilitar bot√≥n para evitar env√≠os duplicados
    if (button) {
        button.disabled = true;
        button.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Generando...';
    }
    
    // Intentar mostrar overlay (si est√° disponible)
    try {
        if (typeof processingOverlay !== 'undefined') {
            showTrackProcessing(trackTitle, midiTitle);
        }
    } catch (error) {
        console.warn('ProcessingOverlay no disponible:', error);
    }
    
    // Cerrar modal
    try {
        const modal = bootstrap.Modal.getInstance(document.getElementById('generateModal'));
        if (modal) {
            modal.hide();
        }
    } catch (error) {
        console.warn('Error cerrando modal:', error);
    }
    
    // Enviar formulario de forma robusta
    const form = this;
    setTimeout(() => {
        try {
            form.submit();
        } catch (error) {
            console.error('Error enviando formulario:', error);
            // Re-habilitar bot√≥n si hay error
            if (button) {
                button.disabled = false;
                button.innerHTML = '<i class="fas fa-magic me-2"></i>Generar Track';
            }
            alert('Error al enviar la solicitud. Por favor, int√©ntalo de nuevo.');
        }
    }, 500); // Reducido de 1000ms a 500ms
});

// Funci√≥n espec√≠fica para mostrar procesamiento de generaci√≥n de tracks
function showTrackProcessing(trackTitle, midiSource) {
    if (typeof processingOverlay !== 'undefined') {
        let message = 'Creando m√∫ltiples versiones usando IA. Esto puede tardar varios minutos.';
        if (trackTitle && midiSource) {
            message = `Creando "${trackTitle}" basada en ${midiSource}`;
        } else if (trackTitle) {
            message = `Creando "${trackTitle}"`;
        }
        
        processingOverlay.show({
            title: 'Generando Nueva Canci√≥n',
            message: message,
            icon: 'fas fa-magic fa-spin fa-3x text-success'
        });
        
        processingOverlay.setStatus('Inicializando modelo de IA musical...');
        
        // Simular progreso espec√≠fico para generaci√≥n de tracks
        let progress = 0;
        const interval = setInterval(() => {
            progress += Math.random() * 8; // Progreso m√°s lento para tracks
            if (progress >= 95) {
                progress = 95;
                clearInterval(interval);
            }
            
            processingOverlay.setProgress(progress);
            
            // Actualizar mensaje de progreso
            if (progress < 15) {
                processingOverlay.setStatus('Cargando modelo Orpheus-Music-Transformer...');
            } else if (progress < 30) {
                processingOverlay.setStatus('Analizando MIDI de entrada...');
            } else if (progress < 50) {
                processingOverlay.setStatus('Generando estructura musical...');
            } else if (progress < 70) {
                processingOverlay.setStatus('Creando melod√≠as y armon√≠as...');
            } else if (progress < 85) {
                processingOverlay.setStatus('Desarrollando variaciones musicales...');
            } else {
                processingOverlay.setStatus('Finalizando y preparando descarga...');
            }
        }, 3000 + Math.random() * 2000); // Intervalos m√°s largos para tracks
    }
}

// Funci√≥n de conveniencia para iniciar generaci√≥n desde botones espec√≠ficos
function startTrackGeneration(midiId, midiTitle) {
    // Simular clic en bot√≥n para abrir modal
    const button = document.querySelector(`[data-midi-id="${midiId}"]`);
    if (button) {
        button.click();
    }
}

// Funci√≥n para mostrar progreso de tracks ya en procesamiento
function showExistingTrackProgress(trackTitle) {
    if (typeof processingOverlay !== 'undefined') {
        processingOverlay.show({
            title: 'Generaci√≥n en Progreso',
            message: `La canci√≥n "${trackTitle}" se est√° generando`,
            icon: 'fas fa-magic fa-spin fa-3x text-success'
        });
        
        processingOverlay.setStatus('Esta p√°gina se actualizar√° autom√°ticamente cuando est√© lista...');
        
        // Progreso indeterminado para tracks existentes
        let progress = 50;
        processingOverlay.setProgress(progress);
        
        const interval = setInterval(() => {
            progress += (Math.random() - 0.5) * 10;
            progress = Math.max(30, Math.min(95, progress));
            processingOverlay.setProgress(progress);
        }, 5000);
        
        // Auto-ocultar despu√©s de un tiempo
        setTimeout(() => {
            clearInterval(interval);
            processingOverlay.hide();
        }, 20000);
    }
}
</script>
{% endblock %}
