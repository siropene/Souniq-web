{% extends 'base.html' %}
{% load static %}
{% load crispy_forms_tags %}

{% block title %}Mis Canciones - SouniQ{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col">
        <h1 class="h2 text-primary">
            <i class="fas fa-music me-2"></i>Mis Canciones
        </h1>
        <p class="text-muted">Gestiona y procesa tus archivos de audio</p>
    </div>
    <div class="col-auto">
        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#uploadModal">
            <i class="fas fa-plus me-2"></i>Subir Canción
        </button>
    </div>
</div>

<!-- Filters and Search -->
<div class="card mb-4">
    <div class="card-body">
        <form method="get" class="row g-3">
            <div class="col-md-6">
                <div class="input-group">
                    <span class="input-group-text"><i class="fas fa-search"></i></span>
                    <input type="text" class="form-control" name="search" placeholder="Buscar canciones..." 
                           value="{{ search_query|default:'' }}">
                </div>
            </div>
            <div class="col-md-3">
                <select name="status" class="form-select">
                    <option value="">Todos los estados</option>
                    <option value="uploaded" {% if status_filter == 'uploaded' %}selected{% endif %}>Subida</option>
                    <option value="processing_stems" {% if status_filter == 'processing_stems' %}selected{% endif %}>Procesando Stems</option>
                    <option value="stems_completed" {% if status_filter == 'stems_completed' %}selected{% endif %}>Stems Completados</option>
                    <option value="error" {% if status_filter == 'error' %}selected{% endif %}>Error</option>
                </select>
            </div>
            <div class="col-md-3">
                <button type="submit" class="btn btn-outline-primary">
                    <i class="fas fa-filter me-2"></i>Filtrar
                </button>
                <a href="{% url 'music_processing:song_list' %}" class="btn btn-outline-secondary">
                    <i class="fas fa-times"></i>
                </a>
            </div>
        </form>
    </div>
</div>

<!-- Songs List -->
{% if songs %}
<div class="row">
    {% for song in songs %}
    <div class="col-lg-6 mb-4">
        <div class="card h-100">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-start mb-3">
                    <h5 class="card-title text-primary">{{ song.title }}</h5>
                    <span class="badge status-badge status-{{ song.status }}">
                        {{ song.get_status_display }}
                    </span>
                </div>
                
                <div class="mb-3">
                    <small class="text-muted">
                        <i class="fas fa-file me-1"></i>{{ song.filename }}
                    </small>
                    {% if song.file_size %}
                    <br>
                    <small class="text-muted">
                        <i class="fas fa-hdd me-1"></i>{{ song.file_size|filesizeformat }}
                    </small>
                    {% endif %}
                    <br>
                    <small class="text-muted">
                        <i class="fas fa-calendar me-1"></i>{{ song.uploaded_at|date:"d M Y H:i" }}
                    </small>
                </div>

                <!-- Audio Player -->
                {% if song.original_file %}
                <div class="audio-player mb-3">
                    <audio controls preload="metadata">
                        <source src="{{ song.original_file.url }}" type="audio/mpeg">
                        Tu navegador no soporta el elemento de audio.
                    </audio>
                </div>
                {% endif %}

                <!-- Stems Info -->
                {% if song.stems.exists %}
                <div class="mb-3">
                    <small class="text-success">
                        <i class="fas fa-layer-group me-1"></i>{{ song.stems.count }} stems generados
                    </small>
                </div>
                {% elif song.status == 'uploaded' %}
                <div class="mb-3">
                    <div class="alert alert-info py-2 mb-0">
                        <i class="fas fa-info-circle me-1"></i>
                        <small>Canción lista para generar stems. Ve a la sección <strong>Stems</strong> para continuar.</small>
                    </div>
                </div>
                {% endif %}

                <!-- Actions -->
                <div class="d-flex gap-2 flex-wrap">
                    {% if song.original_file %}
                    <a href="{% url 'music_processing:download_file' 'song' song.id %}" 
                       class="btn btn-sm btn-outline-primary">
                        <i class="fas fa-download me-1"></i>Descargar
                    </a>
                    {% endif %}
                    
                    {% if song.status == 'uploaded' %}
                    <a href="{% url 'music_processing:stems' %}" class="btn btn-sm btn-info">
                        <i class="fas fa-layer-group me-1"></i>Ir a Stems
                    </a>
                    {% endif %}
                    
                    <a href="{% url 'music_processing:delete_song' song.id %}" 
                       class="btn btn-sm btn-outline-danger"
                       onclick="return confirm('¿Estás seguro de que quieres eliminar esta canción y todos sus archivos relacionados?')">
                        <i class="fas fa-trash me-1"></i>Eliminar
                    </a>
                </div>
            </div>
        </div>
    </div>
    {% endfor %}
</div>

<!-- Pagination -->
{% if songs.has_other_pages %}
<nav aria-label="Navegación de páginas">
    <ul class="pagination justify-content-center">
        {% if songs.has_previous %}
            <li class="page-item">
                <a class="page-link" href="?page={{ songs.previous_page_number }}{% if search_query %}&search={{ search_query }}{% endif %}{% if status_filter %}&status={{ status_filter }}{% endif %}">
                    <i class="fas fa-chevron-left"></i>
                </a>
            </li>
        {% endif %}
        
        {% for num in songs.paginator.page_range %}
            {% if songs.number == num %}
                <li class="page-item active">
                    <span class="page-link">{{ num }}</span>
                </li>
            {% elif num > songs.number|add:'-3' and num < songs.number|add:'3' %}
                <li class="page-item">
                    <a class="page-link" href="?page={{ num }}{% if search_query %}&search={{ search_query }}{% endif %}{% if status_filter %}&status={{ status_filter }}{% endif %}">{{ num }}</a>
                </li>
            {% endif %}
        {% endfor %}
        
        {% if songs.has_next %}
            <li class="page-item">
                <a class="page-link" href="?page={{ songs.next_page_number }}{% if search_query %}&search={{ search_query }}{% endif %}{% if status_filter %}&status={{ status_filter }}{% endif %}">
                    <i class="fas fa-chevron-right"></i>
                </a>
            </li>
        {% endif %}
    </ul>
</nav>
{% endif %}

{% else %}
<div class="text-center py-5">
    <i class="fas fa-music text-muted" style="font-size: 4rem;"></i>
    <h3 class="mt-3 text-muted">No tienes canciones subidas</h3>
    <p class="text-muted">Sube tu primera canción para comenzar el proceso de IA:</p>
    <div class="row justify-content-center mt-4 mb-4">
        <div class="col-md-8">
            <div class="d-flex justify-content-center align-items-center flex-wrap gap-3">
                <div class="text-center">
                    <div class="badge bg-primary rounded-pill mb-1">1</div>
                    <small class="d-block">Subir Canción</small>
                </div>
                <i class="fas fa-arrow-right text-muted"></i>
                <div class="text-center">
                    <div class="badge bg-secondary rounded-pill mb-1">2</div>
                    <small class="d-block">Generar Stems</small>
                </div>
                <i class="fas fa-arrow-right text-muted"></i>
                <div class="text-center">
                    <div class="badge bg-secondary rounded-pill mb-1">3</div>
                    <small class="d-block">Convertir MIDI</small>
                </div>
                <i class="fas fa-arrow-right text-muted"></i>
                <div class="text-center">
                    <div class="badge bg-secondary rounded-pill mb-1">4</div>
                    <small class="d-block">Generar Tracks</small>
                </div>
            </div>
        </div>
    </div>
    <button class="btn btn-primary btn-lg" data-bs-toggle="modal" data-bs-target="#uploadModal">
        <i class="fas fa-plus me-2"></i>Subir Primera Canción
    </button>
</div>
{% endif %}

<!-- Upload Modal -->
<div class="modal fade" id="uploadModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-upload me-2"></i>Subir Nueva Canción
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="post" action="{% url 'music_processing:upload_song' %}" enctype="multipart/form-data">
                <div class="modal-body">
                    {% csrf_token %}
                    
                    <div class="mb-3">
                        <label for="{{ upload_form.title.id_for_label }}" class="form-label">Título de la canción</label>
                        {{ upload_form.title.as_widget }}
                        {% if upload_form.title.errors %}
                            <div class="text-danger small mt-1">{{ upload_form.title.errors.0 }}</div>
                        {% endif %}
                    </div>

                    <div class="mb-3">
                        <label for="{{ upload_form.original_file.id_for_label }}" class="form-label">Archivo de audio</label>
                        <div class="file-upload-area" id="file-upload-area">
                            <i class="fas fa-cloud-upload-alt fa-3x text-muted mb-3"></i>
                            <h5 class="text-muted">Arrastra tu archivo aquí o haz clic para seleccionar</h5>
                            <p class="text-muted small mb-0">
                                Formatos soportados: MP3, WAV, FLAC, AAC, M4A (máx. 50MB)
                            </p>
                        </div>
                        <div style="display: none;">
                            {{ upload_form.original_file }}
                        </div>
                        {% if upload_form.original_file.errors %}
                            <div class="text-danger small mt-1">{{ upload_form.original_file.errors.0 }}</div>
                        {% endif %}
                    </div>

                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        <strong>Información:</strong> Una vez subida, ve a la sección de <strong>Stems</strong> para generar las pistas separadas usando nuestra IA. 
                        El proceso puede tardar varios minutos dependiendo de la duración de la canción.
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-upload me-2"></i>Subir Canción
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// File handling for upload modal
document.addEventListener('DOMContentLoaded', function() {
    const fileInput = document.getElementById('{{ upload_form.original_file.id_for_label }}');
    const titleField = document.getElementById('{{ upload_form.title.id_for_label }}');
    const uploadArea = document.getElementById('file-upload-area');
    
    console.log('Elements found:', {
        fileInput: fileInput ? fileInput.id : 'not found',
        titleField: titleField ? titleField.id : 'not found',
        uploadArea: uploadArea ? 'found' : 'not found'
    });
    
    if (fileInput && uploadArea) {
        // Click handler for upload area
        uploadArea.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            console.log('Upload area clicked, triggering file input');
            fileInput.click();
        });
        
        // File input change handler
        fileInput.addEventListener('change', function() {
            console.log('File input changed, files:', this.files.length);
            const file = this.files[0];
            
            if (file) {
                console.log('File selected:', file.name, 'Size:', file.size);
                
                // Validate file
                if (validateFile(this, file)) {
                    // Auto-fill title from filename if title is empty
                    if (titleField && !titleField.value) {
                        const filename = file.name.replace(/\.[^/.]+$/, ""); // Remove extension
                        titleField.value = filename;
                    }
                    
                    // Update visual feedback
                    updateUploadAreaVisual(uploadArea, file);
                }
            }
        });
        
        // Drag and drop handlers
        uploadArea.addEventListener('dragover', function(e) {
            e.preventDefault();
            e.stopPropagation();
            uploadArea.classList.add('dragover');
        });
        
        uploadArea.addEventListener('dragleave', function(e) {
            e.preventDefault();
            e.stopPropagation();
            uploadArea.classList.remove('dragover');
        });
        
        uploadArea.addEventListener('drop', function(e) {
            e.preventDefault();
            e.stopPropagation();
            uploadArea.classList.remove('dragover');
            
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                fileInput.files = files;
                fileInput.dispatchEvent(new Event('change'));
            }
        });
    } else {
        console.error('Required elements not found for file upload');
    }
    
    function validateFile(input, file) {
        const allowedTypes = ['audio/mpeg', 'audio/wav', 'audio/flac', 'audio/aac', 'audio/m4a'];
        const maxSize = 50 * 1024 * 1024; // 50MB
        
        if (!allowedTypes.includes(file.type) && !file.name.match(/\.(mp3|wav|flac|aac|m4a)$/i)) {
            alert('Por favor, selecciona un archivo de audio válido (MP3, WAV, FLAC, AAC, M4A)');
            input.value = '';
            return false;
        }
        
        if (file.size > maxSize) {
            alert('El archivo no puede superar los 50MB');
            input.value = '';
            return false;
        }
        
        return true;
    }
    
    function updateUploadAreaVisual(uploadArea, file) {
        const fileSize = (file.size / (1024 * 1024)).toFixed(2);
        
        // Remove existing file info if any
        const existingInfo = uploadArea.querySelector('.file-info');
        if (existingInfo) {
            existingInfo.remove();
        }
        
        // Add file info
        const fileInfo = document.createElement('div');
        fileInfo.className = 'file-info mt-3 p-2 bg-light rounded border';
        fileInfo.innerHTML = `
            <div class="d-flex align-items-center justify-content-center text-success">
                <i class="fas fa-file-audio text-primary me-2"></i>
                <span class="fw-medium me-2">${file.name}</span>
                <span class="text-muted">(${fileSize} MB)</span>
            </div>
            <small class="text-success d-block mt-1 text-center">
                <i class="fas fa-check-circle me-1"></i>Archivo seleccionado correctamente
            </small>
        `;
        
        uploadArea.appendChild(fileInfo);
        uploadArea.classList.add('file-selected');
    }
});
</script>
{% endblock %}
